---
interface Props {
  score: string
  version: string
  stars: string
  notes: string
  github: string
  demo?: string
  npm: string
  nav: string
  dots: string
}

const { score, version, stars, notes, github, demo, npm, nav, dots } = Astro.props

const isitaccessibleUrl = `https://isitaccessible.dev/package/${encodeURIComponent(npm)}`

const navLabels: Record<string, string> = {
  below: 'Below carousel',
  overlay: 'Overlay on slides',
  'built-in': 'Built-in controls',
}

const dotsLabels: Record<string, string> = {
  custom: 'Custom (DIY)',
  'built-in': 'Built-in',
  plugin: 'Plugin required',
  component: 'Component provided',
}

const linkClass = "text-stone-700 underline underline-offset-2 font-medium hover:text-amber-700 focus:outline-2 focus:outline-amber-500 focus:outline-offset-2 focus:rounded-sm"
const valueLinkClass = "text-stone-950 underline underline-offset-2 font-semibold hover:text-amber-700 focus:outline-2 focus:outline-amber-500 focus:outline-offset-2 focus:rounded-sm"
---

<div class="bg-stone-100 rounded-lg p-4 mb-6 text-sm">
  <div class="grid gap-3 mb-3" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
    <div class="flex flex-col gap-0.5">
      <span class="text-xs font-semibold uppercase text-stone-600">A11y Score</span>
      <span class="font-medium text-stone-950">
        <a href={isitaccessibleUrl} target="_blank" rel="noopener" class={valueLinkClass}>
          {score}
          <span class="sr-only">(opens in new tab)</span>
        </a>
      </span>
    </div>
    <div class="flex flex-col gap-0.5">
      <span class="text-xs font-semibold uppercase text-stone-600">Version Tested</span>
      <span class="font-medium text-stone-950">{version}</span>
    </div>
    <div class="flex flex-col gap-0.5">
      <span class="text-xs font-semibold uppercase text-stone-600">GitHub Stars</span>
      <span class="font-medium text-stone-950">{stars}</span>
    </div>
    <div class="flex flex-col gap-0.5">
      <span class="text-xs font-semibold uppercase text-stone-600">Nav Style</span>
      <span class="font-medium text-stone-950">{navLabels[nav] || nav}</span>
    </div>
    <div class="flex flex-col gap-0.5">
      <span class="text-xs font-semibold uppercase text-stone-600">Dots/Pagination</span>
      <span class="font-medium text-stone-950">{dotsLabels[dots] || dots}</span>
    </div>
  </div>
  <p class="m-0 mb-3 text-stone-600 italic">{notes}</p>
  <div class="flex gap-6 flex-wrap items-center">
    <a href={github} target="_blank" rel="noopener" class={linkClass}>
      View on GitHub<span class="sr-only"> (opens in new tab)</span> →
    </a>
    {demo && (
      <a href={demo} target="_blank" rel="noopener" class={linkClass}>
        View Demo<span class="sr-only"> (opens in new tab)</span> →
      </a>
    )}
    <button
      type="button"
      id="run-axe"
      class="bg-stone-800 text-white border-none py-1.5 px-3 rounded text-sm font-medium cursor-pointer ml-auto hover:bg-stone-700 focus:outline-2 focus:outline-amber-500 focus:outline-offset-2 disabled:bg-stone-400 disabled:cursor-wait"
    >
      Run Accessibility Test
    </button>
  </div>
  <div id="axe-results"></div>
</div>

<script>
  const axeBtn = document.getElementById('run-axe')
  const axeResults = document.getElementById('axe-results')

  if (axeBtn && axeResults) {
    axeBtn.addEventListener('click', async () => {
      axeBtn.textContent = 'Running...'
      axeBtn.setAttribute('disabled', 'true')

      try {
        const axe = (await import('axe-core')).default
        const results = await axe.run('.carousel-section')

        if (results.violations.length === 0) {
          axeResults.innerHTML = `
            <h3 class="pass">No accessibility violations found!</h3>
            <p>This carousel passed all ${results.passes.length} axe-core checks.</p>
          `
        } else {
          let html = `<h3 class="error">${results.violations.length} Accessibility Violation${results.violations.length > 1 ? 's' : ''}</h3>`
          html += '<table><thead><tr><th>Impact</th><th>Issue</th><th>Elements</th></tr></thead><tbody>'

          for (const v of results.violations) {
            html += `<tr>
              <td><span class="impact-${v.impact}">${v.impact}</span></td>
              <td><strong>${v.id}</strong>: ${v.help}</td>
              <td>${v.nodes.length} element${v.nodes.length > 1 ? 's' : ''}</td>
            </tr>`
          }
          html += '</tbody></table>'

          for (const v of results.violations) {
            html += `<details>
              <summary><strong>${v.id}</strong>: ${v.help}</summary>
              <p>${v.description}</p>
              <p><a href="${v.helpUrl}" target="_blank" rel="noopener">Learn more</a></p>
              <ul>
                ${v.nodes.map(n => `<li><code>${n.target[0]}</code><br>${n.failureSummary}</li>`).join('')}
              </ul>
            </details>`
          }

          axeResults.innerHTML = html
        }
      } catch (err) {
        axeResults.innerHTML = `<p class="error">Error running axe: ${err}</p>`
      }

      axeBtn.textContent = 'Run Accessibility Test'
      axeBtn.removeAttribute('disabled')
    })
  }
</script>
