---
import { slides } from '../../data/slides'
import Slide from '../Slide.astro'
import 'tiny-slider/dist/tiny-slider.css'
---

<div class="tiny-slider carousel-loading" id="tiny-slider" aria-label="Featured content carousel" role="region">
  {slides.map((s) => (
    <div class="tiny-slide">
      <Slide {...s} />
    </div>
  ))}
</div>

<div id="tiny-controls" class="flex justify-center gap-4 mt-4">
  <button type="button" class="carousel-btn">Previous</button>
  <button type="button" class="carousel-btn">Next</button>
</div>

<div id="tiny-dots" class="flex justify-center gap-2 mt-4">
  {slides.map((_, i) => (
    <button
      type="button"
      class={`tiny-dot w-3 h-3 rounded-full border-none cursor-pointer p-0 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 ${i === 0 ? 'bg-stone-800' : 'bg-stone-300 hover:bg-stone-400'}`}
      aria-label={`Go to slide ${i + 1}`}
      aria-current={i === 0 ? 'true' : undefined}
      data-index={i}
    />
  ))}
</div>

<script>
  import { updateDots, updateSlideFocus, setCarouselReady } from '../../utils/carousel'

  async function initTiny() {
    const { tns } = await import('tiny-slider')
    const dots = document.querySelectorAll('.tiny-dot')
    const totalSlides = document.querySelectorAll('#tiny-slider .tiny-slide').length

    const updateTinyFocus = () => {
      const allSlides = document.querySelectorAll('.tns-item')
      updateSlideFocus(allSlides, (slide) => slide.classList.contains('tns-slide-active'))
    }

    const slider = tns({
      container: '#tiny-slider',
      items: 1,
      slideBy: 'page',
      autoplay: false,
      controls: true,
      controlsContainer: '#tiny-controls',
      nav: false,
      touch: true,
      mouseDrag: true,
      loop: true,
    })

    // Initial focus setup (tiny-slider needs a delay for DOM updates)
    setTimeout(() => {
      updateTinyFocus()
      // Fix: tiny-slider sets tabindex="-1" on control buttons, restore keyboard access
      document.querySelectorAll('#tiny-controls button').forEach((btn) => btn.removeAttribute('tabindex'))
      setCarouselReady(document.getElementById('tiny-slider'))
    }, 100)

    slider.events.on('indexChanged', (info: any) => {
      const realIndex = (info.displayIndex - 1) % totalSlides
      updateDots(dots, realIndex)
      updateTinyFocus()
    })

    dots.forEach((dot) => {
      dot.addEventListener('click', () => {
        const index = Number(dot.getAttribute('data-index'))
        slider.goTo(index)
      })
    })
  }

  initTiny()
</script>
