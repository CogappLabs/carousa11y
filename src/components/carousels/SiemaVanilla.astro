---
import { slides } from '../../data/slides'
import Slide from '../Slide.astro'
---

<div class="siema carousel-loading" aria-label="Featured content carousel" role="region">
  {slides.map((s) => (
    <div class="siema-slide">
      <Slide {...s} />
    </div>
  ))}
</div>
<div class="siema-controls flex justify-center gap-4 mt-4">
  <button class="siema-prev carousel-btn" type="button">Previous</button>
  <button class="siema-next carousel-btn" type="button">Next</button>
</div>
<div id="siema-dots" class="flex justify-center gap-2 mt-4">
  {slides.map((_, i) => (
    <button
      type="button"
      class={`siema-dot w-3 h-3 rounded-full border-none cursor-pointer p-0 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 ${i === 0 ? 'bg-stone-800' : 'bg-stone-300 hover:bg-stone-400'}`}
      aria-label={`Go to slide ${i + 1}`}
      aria-current={i === 0 ? 'true' : undefined}
      data-index={i}
    />
  ))}
</div>

<script>
  async function initSiema() {
    const Siema = (await import('siema')).default
    const dots = document.querySelectorAll('.siema-dot')

    const updateDots = (index: number) => {
      dots.forEach((dot, i) => {
        const isActive = i === index
        dot.classList.toggle('bg-stone-800', isActive)
        dot.classList.toggle('bg-stone-300', !isActive)
        dot.classList.toggle('hover:bg-stone-400', !isActive)
        dot.setAttribute('aria-current', isActive ? 'true' : 'false')
      })
    }

    const siemaEl = document.querySelector('.siema')
    const siema = new Siema({
      selector: '.siema',
      loop: true,
      draggable: true,
      threshold: 20,
      onChange: function (this: any) {
        updateDots(this.currentSlide)
      },
    })
    siemaEl?.classList.add('siema-initialized')
    siemaEl?.classList.remove('carousel-loading')
    siemaEl?.classList.add('carousel-ready')

    document.querySelector('.siema-prev')?.addEventListener('click', () => siema.prev())
    document.querySelector('.siema-next')?.addEventListener('click', () => siema.next())

    dots.forEach((dot) => {
      dot.addEventListener('click', () => {
        const index = Number(dot.getAttribute('data-index'))
        siema.goTo(index)
        updateDots(index)
      })
    })
  }

  initSiema()
</script>
