---
import { slides } from '../../data/slides'
import Slide from '../Slide.astro'
---

<div class="overflow-hidden carousel-loading" id="embla-container" role="region" aria-label="Featured content carousel">
  <div id="embla-viewport" class="overflow-hidden">
    <div class="flex">
      {slides.map((s) => (
        <Slide {...s} class="flex-[0_0_100%] min-w-0 px-4" />
      ))}
    </div>
  </div>
  <div class="flex justify-center gap-4 mt-4">
    <button id="embla-prev" type="button" class="carousel-btn">Previous</button>
    <button id="embla-next" type="button" class="carousel-btn">Next</button>
  </div>
  <div id="embla-dots" class="flex justify-center gap-2 mt-4"></div>
</div>

<script>
  async function initEmbla() {
    const EmblaCarousel = (await import('embla-carousel')).default
    const Accessibility = (await import('embla-carousel-accessibility')).default

    const emblaNode = document.getElementById('embla-viewport')
    if (!emblaNode) return

    const embla = EmblaCarousel(emblaNode, { loop: true }, [Accessibility()])

    document.getElementById('embla-prev')?.addEventListener('click', () => embla.goToPrev())
    document.getElementById('embla-next')?.addEventListener('click', () => embla.goToNext())

    const emblaDots = document.getElementById('embla-dots')
    if (!emblaDots) return

    const slideNodes = embla.slideNodes()
    emblaDots.innerHTML = slideNodes
      .map((_, i) => `<button type="button" class="w-3 h-3 rounded-full bg-stone-300 border-none p-0 cursor-pointer focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2" aria-label="Go to slide ${i + 1}"></button>`)
      .join('')

    const dots = emblaDots.querySelectorAll('button')
    dots.forEach((dot, i) => dot.addEventListener('click', () => embla.goTo(i)))

    const updateDots = () => {
      const selected = embla.selectedSnap()
      dots.forEach((dot, i) => {
        dot.classList.toggle('bg-stone-800', i === selected)
        dot.classList.toggle('bg-stone-300', i !== selected)
        dot.setAttribute('aria-current', i === selected ? 'true' : 'false')
      })
    }

    embla.on('select', updateDots)
    updateDots()

    const container = document.getElementById('embla-container')
    container?.classList.remove('carousel-loading')
    container?.classList.add('carousel-ready')
  }

  initEmbla()
</script>
