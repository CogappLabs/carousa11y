---
import { slides } from '../../data/slides'
import Slide from '../Slide.astro'
---

<div class="flicking-viewport carousel-loading" role="region" aria-label="Featured content carousel">
  <div class="flicking-camera">
    {slides.map((s) => (
      <Slide {...s} class="flicking-panel" />
    ))}
  </div>
</div>
<div class="flex justify-center gap-4 mt-4">
  <button class="flicking-prev carousel-btn" type="button">Previous</button>
  <button class="flicking-next carousel-btn" type="button">Next</button>
</div>
<div class="flicking-pagination flex justify-center gap-2 mt-4"></div>

<script>
  import { createDots, updateDots, setCarouselReady } from '../../utils/carousel'

  async function initFlicking() {
    const { default: Flicking, connectFlickingReactiveAPI } = await import('@egjs/flicking')

    const viewport = document.querySelector('.flicking-viewport')
    const pagination = document.querySelector('.flicking-pagination')
    if (!viewport || !pagination) return

    const flicking = new Flicking('.flicking-viewport', {
      circular: true,
      align: 'prev',
      panelsPerView: 1,
      inputType: ['touch', 'mouse'],
      moveType: 'snap',
      preventDefaultOnDrag: true,
    })

    const reactiveObj = connectFlickingReactiveAPI(flicking)

    const dots = createDots(pagination, reactiveObj.totalPanelCount, (i) => reactiveObj.moveTo(i))
    reactiveObj.subscribe('currentPanelIndex', (index: number) => updateDots(dots, index))

    document.querySelector('.flicking-prev')?.addEventListener('click', () => flicking.prev().catch(() => {}))
    document.querySelector('.flicking-next')?.addEventListener('click', () => flicking.next().catch(() => {}))

    setCarouselReady(viewport)
  }

  initFlicking()
</script>
