---
import { slides } from '../../data/slides'
import Slide from '../Slide.astro'
import 'flickity/css/flickity.css'
---

<div class="flickity-carousel carousel-loading" aria-label="Featured content carousel" role="region">
  {slides.map((s) => (
    <div class="flickity-slide">
      <Slide {...s} />
    </div>
  ))}
</div>

<div class="flex justify-center gap-4 mt-4">
  <button type="button" id="flickity-prev" class="carousel-btn">Previous</button>
  <button type="button" id="flickity-next" class="carousel-btn">Next</button>
</div>
<div id="flickity-dots" class="flex justify-center gap-2 mt-4">
  {slides.map((_, i) => (
    <button
      type="button"
      class={`flickity-dot w-3 h-3 rounded-full border-none cursor-pointer p-0 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 ${i === 0 ? 'bg-stone-800' : 'bg-stone-300 hover:bg-stone-400'}`}
      aria-label={`Go to slide ${i + 1}`}
      aria-current={i === 0 ? 'true' : undefined}
      data-index={i}
    />
  ))}
</div>

<script>
  import { updateDots, updateSlideFocus, setCarouselReady } from '../../utils/carousel'

  async function initFlickity() {
    const Flickity = (await import('flickity')).default
    const dots = document.querySelectorAll('.flickity-dot')
    const slides = document.querySelectorAll('.flickity-slide')

    const carouselEl = document.querySelector('.flickity-carousel')
    const flkty = new Flickity('.flickity-carousel', {
      cellAlign: 'left',
      contain: true,
      wrapAround: true,
      prevNextButtons: false,
      pageDots: false,
      accessibility: true,
    })

    setCarouselReady(carouselEl)
    updateSlideFocus(slides, (_, i) => i === 0)

    flkty.on('select', () => {
      updateSlideFocus(slides, (_, i) => i === flkty.selectedIndex)
      updateDots(dots, flkty.selectedIndex)
    })

    document.getElementById('flickity-prev')?.addEventListener('click', () => flkty.previous())
    document.getElementById('flickity-next')?.addEventListener('click', () => flkty.next())

    dots.forEach((dot) => {
      dot.addEventListener('click', () => {
        const index = Number(dot.getAttribute('data-index'))
        flkty.select(index)
      })
    })
  }

  initFlickity()
</script>
